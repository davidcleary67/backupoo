#!/usr/bin/python3

# import modules
import sys, os, pathlib, shutil, smtplib
from datetime import datetime
# from backupcfg import jobs, logfile, usage_msg, job_msg, recipient, email_user, email_pwd, server, port

class EmailConfig(object):
    '''
    Individual Email configuration details.
    '''

    def __init__(self, *args):
        '''
        class EmailConfig constructor

        Set class attributes to initial values.

        Parameters:
            args[0]: email address of recipient
            args[1]: email address of user
            args[2]: pwd
            args[3]: server
            args[4]: port
        '''
        
        self.recipient  = args[0] 
        self.user = args[1] 
        self.pwd = args[2] 
        self.server = args[3]
        self.port = args[4] 

class Job(object):
    '''
    Individual job details.
    '''

    def __init__(self, *args):
        '''
        class Job constructor

        Set class attributes to initial values.

        Parameters:
            args[0]: job name
            args[1]: source file or directory
            args[2]: destination directory
        '''

        self.name = args[0]
        self.src = args[1]
        self.dst = args[2]

        self.is_file_job = pathlib.Path(self.src).is_file()
        self.is_dir_job = pathlib.Path(self.src).is_dir()

    def __eq__(self, other):
        '''
        Return:
            True when other is name
        '''

        return other == self.name

class Backup(object):
    '''
    Backup a file system object.
    '''

    def __init__(self, *args):
        '''
        class Backup constructor

        Set class attributes to initial values.

        Parameter count:
            0: set attributes to defaults
            3: set attributes to args[]

        Parameters:
            args[0]: formatted datetime string
            args[1]: number errors
            args[2]: messages
        '''
        
        self.datestring = datetime.now().strftime("%Y%m%d-%H%M%S")
        self.errors = 0
        self.message = []
        self.backed_up = False

        if len(args) == 0:
            self.job = None
            self.logfile = "./backup.log"
            self.email_config = None

        elif len(args) == 3:
            self.job = args[0]
            self.logfile = args[1]
            self.email_config = args[2]

    def do_logfile(self):
        '''
        Output all log messages to logfile.
        '''

        file = open(self.logfile,"a")
        for msg in self.message:
            logmsg = self.datestring + " " + self.job.name + " " + msg
            file.write(logmsg + "\n")
        file.close()

    def do_email(self):
        '''
        Output all log message as email.
        '''
        
        header = 'To: ' + self.email_config.recipient + '\n' + 'From: ' + self.email_config.user + '\n' + 'Subject: Backup Error ' + self.job + '\n'
        msg = header + '\n'
        
        for item in message:
            msg = msg + item + '\n'
        msg = msg + '\n\n'

        smtpserver = smtplib.SMTP(self.email_config.server, self.email_config.port)
        smtpserver.ehlo()
        smtpserver.starttls()
        smtpserver.login(self.email_config.user, self.email_config.pwd)
        smtpserver.sendmail(self.email_config.user, self.email_config.recipient, msg)
        smtpserver.quit()

    def do_backup(self):
        '''
        Backup source file to destination.
        '''

        # Local variables to shorten code
        name = self.job.name
        src = self.job.src
        dst = self.job.dst
        
        # Check source and destination paths exist
        if not os.path.exists(src):
            self.message.append("Source " + src + " does not exist -> FAIL")
            self.errors += 1

        if not os.path.exists(dst):
            self.message.append("Destination directory " + dst + " does not exist -> FAIL")
            self.errors += 1

        if self.errors == 0:

            # Construct source and destination paths
            src_path = pathlib.Path(src)
            src_path_only = pathlib.PurePath(src)
            dst_path = dst + "/" + src_path_only.name + "-" + self.datestring

            # Copy source file to destination
            if src_path.is_file():

                try:
                    shutil.copy2(src, dst_path)
                    self.message.append("Backup of file " + src + " -> SUCCEED")
                except:
                    self.message.append("Backup of file " + src + " -> FAIL")
                    self.errors += 1

            # Copy source directory to destination
            elif src_path.is_dir():
                try:
                    shutil.copytree(src, dst_path)
                    self.message.append("Backup of directory " + src + " -> SUCCEED")
                except:
                    self.message.append("Backup of directory " + src + " -> FAIL")
                    self.errors += 1

class BackupFile(Backup):
    '''
    Backup a file system file.
    '''

    def do_backup(self):
        '''
        Backup source file to destination.
        '''

        # Local variables to shorten code
        name = self.job.name
        src = self.job.src
        dst = self.job.dst
        
        # Check source and destination paths exist
        if not os.path.exists(src):
            self.message.append("Source " + src + " does not exist -> FAIL")
            self.errors += 1

        if not os.path.exists(dst):
            self.message.append("Destination directory " + dst + " does not exist -> FAIL")
            self.errors += 1

        if self.errors == 0:

            # Construct source and destination paths
            src_path = pathlib.Path(src)
            src_path_only = pathlib.PurePath(src)
            dst_path = dst + "/" + src_path_only.name + "-" + self.datestring

            # Copy source file to destination
            if src_path.is_file():

                try:
                    shutil.copy2(src, dst_path)
                    self.message.append("Backup of file " + src + " -> SUCCEED")
                except:
                    self.message.append("Backup of file " + src + " -> FAIL")
                    self.errors += 1

            # Copy source directory to destination
            elif src_path.is_dir():
                try:
                    shutil.copytree(src, dst_path)
                    self.message.append("Backup of directory " + src + " -> SUCCEED")
                except:
                    self.message.append("Backup of directory " + src + " -> FAIL")
                    self.errors += 1
class BackupDirectory(Backup):
    '''
    Backup a file system .
    '''

#  main routine
if __name__ == '__main__':

    email_config = EmailConfig('mhall@sunitafe.edu.au',
                               'mhall@sunitafe.edu.au',
                               'xxxxxxxx',
                               'mail.example.com',
                               587)

    jobs = [Job('job1', '/home/ec2-user/environment/backupoo/test/dir1', '/home/ec2-user/environment/backupoo/backup'),
            Job('job2', '/home/ec2-user/environment/backupoo/test/file1','/home/ec2-user/environment/backupoo/backup'),
            Job('job3', '/home/ec2-user/environment/backupoo/test/fileX','/home/ec2-user/environment/backupoo/backup'),
            Job('job4', '/home/ec2-user/environment/backupoo/test/file1','/home/ec2-user/environment/backupoo/backupX')]

    usage_msg = 'Usage: python backup.py <job_name>'
    
    job_msg = 'Invalid job number.  Job number not in list of jobs.'
    
    logfile = '/home/ec2-user/environment/backupoo/backupoo.log'

    if len(sys.argv) != 2:

        print(usage_msg)

    else:

        job_name = sys.argv[1]

        # if valid job then backup job
        if job_name not in jobs:

            print(job_msg)

        else:
            
            backup = Backup(jobs[jobs.index(job_name)], logfile, email_config)

            print(backup.job.name)
            print(backup.job.src)
            print(backup.job.dst)
            print(jobs[jobs.index(job_name)].is_dir_job)
            
            backup.do_backup()

            if backup.errors:
                pass
                # backup.do_email()

            backup.do_logfile()
